# Stock MLOps Implementation Plan

## Phase 3: WebApp

### 3.1 UI/UX Specifications (Streamlit)
**Design System:**
- **Theme:** Professional Financial Dark Mode (Black/Dark Grey backgrounds, Stark White text).
- **Color Palette:**
    - Bullish (Hausse): `#00C805` (Matrix Green) or Neon Green.
    - Bearish (Baisse): `#FF3B30` (Signal Red).
    - Neutral/Info: `#0A84FF` (Blue).
    - **FORBIDDEN:** Do NOT use Purple/Violet (Strict `frontend-specialist` rule).
- **Layout:** Sidebar for Controls & Health, Main Column for Charts & Insights.

### 3.2 Key Features & Components

#### A. The Finance Super-Chart (Main View)
- **Library:** `plotly.graph_objects` (Interactive).
- **Data:** Candlestick chart (Open/High/Low/Close).
- **Overlays:**
    - SMA-20 (Yellow dashed line) & SMA-50 (Blue dashed line).
    - **Prediction Zone:** Shaded area extending to J+1 representing the LSTM forecast range (Confidence Interval).

#### B. Sidebar "Model Health" Panel
- **Real-time Monitoring:** Connects to `artifacts/` or `evidently` metrics.
- **Components:**
    - `st.metric(label="Model Status", value="Stable", delta="No Drift")`
    - `st.progress` bar showing feedback count (e.g., "34/50 to Retrain").
    - Last Training Accuracy (RMSE).

#### C. "Battle Mode" Feedback Loop (Gamification)
- **Location:** Below the main chart.
- **Interaction:**
    - Two large columns: [ ðŸŸ¢ I Agree (Valid) ] vs [ ðŸ”´ I Disagree (Correct) ].
    - **Scoreboard:** "Model Accuracy vs. Your Accuracy" (Session state).
    - **Action:** Clicking sends payload to `serving-api:8080/feedback`.

#### D. Intelligent Insight Agent
- **Component:** `st.expander("ðŸ¤– Why this prediction?", expanded=True)`
- **Content:** Text generated by the Output Agent.
    - Structure: *Trend Analysis* + *Risk Warning (Evidently)* + *Fundamental Context (News)*.

#### E. Market Sentiment Gauge
- **Library:** `plotly.graph_objects` (Indicator/Gauge).
- **Logic:** Visual representation of recent news sentiment (Fear vs Greed).
- **Alert:** Display a `st.warning` if Sentiment contradicts the LSTM Prediction (Divergence).

## Phase 4: Agent Service (LangChain)

### 4.1 Architecture
- **Service Name:** `agent_service`
- **Port:** 8083
- **Tech Stack:** Python 3.10, FastAPI, LangChain, LangChain-OpenAI/Google.
- **Network:** Connected to `prod_net` (Access to `serving-api` and `evidently` reports).

### 4.2 Agent Capabilities (Tools)
The agent will utilize the ReAct pattern with the following custom tools:

#### A. ModelInspector (Internal)
- **Function:** Queries `serving-api:8080/predict` to retrieve the LSTM model's technical forecast.
- **Input:** Ticker Symbol (e.g., "AAPL").
- **Output:** JSON with `target_price`, `signal`, and `confidence`.

#### B. DriftAuditor (Monitoring)
- **Function:** Parses the latest JSON report from the shared `reporting/` volume or `monitoring-service` to assess data stability.
- **Input:** None (or specific report ID).
- **Output:** Drift status (Detected/Not Detected) and Drill Score.

#### C. NewsScraper (External)
- **Tool:** `langchain_community.tools.DuckDuckGoSearchRun`.
- **Function:** Fetches real-time financial news and sentiment for the specific ticker.
- **Query:** "{Ticker} stock news today financial analysis".

### 4.3 Insight Pipeline (Workflow)
1.  **Trigger:** User initiates "Analyze & Notify" in Streamlit (`ui/streamlit_app.py`).
2.  **Request:** Streamlit sends POST request to `agent_service:8083/analyze` with `{ticker: "AAPL"}`.
3.  **Execution (LangChain ReAct Loop):**
    - **Thought:** "I need to check the LSTM prediction." -> **Action:** `ModelInspector`.
    - **Thought:** "Prediction is UP. Is it reliable?" -> **Action:** `DriftAuditor`.
    - **Thought:** "Stable. What's the market context?" -> **Action:** `NewsScraper`.
4.  **Synthesis:** Agent generates a final nuanced paragraph.
5.  **Response:** Returns JSON `{analysis: "..."}` to Streamlit for display.

### 4.4 Verification Plan
#### Automated Tests
- **Unit Tests:** Mock tools and verify Agent logic using `pytest`.
- **Integration Tests:** Verify `agent_service` can communicate with `serving-api` (mocked) and `DuckDuckGo` (internet required or mocked).

#### Manual Verification
- Start all services: `docker-compose up`.
- Trigger analysis in Streamlit.
- Verify logs in `agent_service` to see the Chain of Thought (thoughts/actions).
- Verify final output in Streamlit UI (Expander).
